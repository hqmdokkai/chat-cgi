<html>
  <head>
    <title>Simple Chat</title>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var usernameInput = document.getElementById("username");
        var savedUsername = sessionStorage.getItem("chatUsername");
        if (savedUsername) {
          usernameInput.value = savedUsername;
        }

        function refreshMessages() {
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
              document.getElementById("messages").innerHTML = this.responseText;
            }
          };
          xhttp.open("GET", "cgi-bin/main.py", true);
          xhttp.send();
        }
        setInterval(refreshMessages, 3000); // Refresh messages every 3 seconds

        document
          .getElementById("chatForm")
          .addEventListener("submit", function (event) {
            event.preventDefault(); // Ngăn không cho form submit theo cách thông thường
            var formData = new FormData(this);
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
              if (this.readyState == 4 && this.status == 200) {
                document.getElementById("messages").innerHTML =
                  this.responseText;
                refreshMessages(); // Refresh messages to show the latest ones
              }
            };
            xhttp.open("POST", "cgi-bin/main.py", true);
            xhttp.send(formData);

            var username = usernameInput.value;
            sessionStorage.setItem("chatUsername", username); // Lưu username vào sessionStorage
          });
      });
    </script>
  </head>
  <body onload="refreshMessages()">
    <h1>Simple Chat</h1>
    <form id="chatForm" method="POST" action="cgi-bin/main.py">
      <input
        type="text"
        id="username"
        name="username"
        placeholder="Username"
        size="15"
        required
      />
      <input
        type="text"
        name="message"
        size="45"
        placeholder="Enter message here"
        required
      />
      <input type="submit" value="Send" />
    </form>
    <pre id="messages"><!-- Placeholder for messages --></pre>
  </body>
</html>
